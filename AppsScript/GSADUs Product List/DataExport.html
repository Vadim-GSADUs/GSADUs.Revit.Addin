<!DOCTYPE html>
<html>
  <head>
    <style>
      body { padding: 15px; font-family: Arial, sans-serif; font-size: 13px; background-color: #f5f5f5; }
      h3 { margin: 0 0 15px 0; color: #1b5e20; border-bottom: 2px solid #1b5e20; padding-bottom: 5px; }
      .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
      .btn-primary { background-color: #1b5e20; color: white; }
      .btn-secondary { background-color: #666; color: white; }
      .btn:hover { opacity: 0.9; }
      #status { margin: 10px 0; padding: 10px; border-radius: 4px; }
      .loading { background: #fff3cd; color: #856404; }
      .success { background: #d4edda; color: #155724; }
      .error { background: #f8d7da; color: #721c24; }
      #jsonPreview { 
        width: 100%; 
        height: 400px; 
        font-family: monospace; 
        font-size: 11px; 
        border: 1px solid #ccc; 
        border-radius: 4px;
        white-space: pre;
        overflow: auto;
        background: white;
        padding: 10px;
        box-sizing: border-box;
      }
      .actions { margin-bottom: 15px; }
      .info { font-size: 11px; color: #666; margin-top: 10px; }
    </style>
  </head>
  <body>
    <h3>GSADU Data Export</h3>
    
    <div class="actions">
      <button class="btn btn-primary" onclick="loadData()">üîÑ Load Data</button>
      <button class="btn btn-secondary" onclick="downloadJson()">‚¨áÔ∏è Download JSON</button>
      <button class="btn btn-secondary" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
    </div>
    
    <div id="status" class="loading">Click "Load Data" to fetch current sheet data...</div>
    
    <div id="jsonPreview">JSON will appear here...</div>
    
    <div class="info">
      <strong>Usage:</strong> Download the JSON file and save it to your project folder for reference.<br>
      File includes: SYSTEM_CONFIG (divisions, categories, tiers, bundles, finishes), MASTER_DB products, and CHANGE_LOG.
    </div>
    
    <script>
      let jsonData = null;
      let jsonString = "";
      
      function loadData() {
        document.getElementById('status').className = 'loading';
        document.getElementById('status').textContent = 'Loading data from sheets...';
        
        google.script.run
          .withSuccessHandler(data => {
            if (data === null || data === undefined) {
              document.getElementById('status').className = 'error';
              document.getElementById('status').textContent = 'Error: Function returned null';
              document.getElementById('jsonPreview').textContent = 'null - check Apps Script logs';
              return;
            }
            
            if (data.error) {
              document.getElementById('status').className = 'error';
              document.getElementById('status').textContent = 'Error: ' + data.error;
              document.getElementById('jsonPreview').textContent = JSON.stringify(data, null, 2);
              return;
            }
            
            jsonData = data;
            jsonString = JSON.stringify(data, null, 2);
            document.getElementById('jsonPreview').textContent = jsonString;
            document.getElementById('status').className = 'success';
            document.getElementById('status').textContent = 
              `Loaded: ${data.SYSTEM_CONFIG.divisions.length} divisions, ` +
              `${data.SYSTEM_CONFIG.categories.length} categories, ` +
              `${data.MASTER_DB.length} products`;
          })
          .withFailureHandler(err => {
            document.getElementById('status').className = 'error';
            document.getElementById('status').textContent = 'Error: ' + err.message;
            document.getElementById('jsonPreview').textContent = 'Error details:\n' + JSON.stringify(err, null, 2);
          })
          .exportAllData();
      }
      
      function downloadJson() {
        if (!jsonString) {
          alert('Please load data first');
          return;
        }
        
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = `GSADU_Data_Export_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        document.getElementById('status').textContent = 'Downloaded! Save to your project folder.';
      }
      
      function copyToClipboard() {
        if (!jsonString) {
          alert('Please load data first');
          return;
        }
        
        navigator.clipboard.writeText(jsonString).then(() => {
          document.getElementById('status').className = 'success';
          document.getElementById('status').textContent = 'Copied to clipboard!';
        }).catch(err => {
          // Fallback for older browsers
          const textarea = document.createElement('textarea');
          textarea.value = jsonString;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          document.getElementById('status').textContent = 'Copied to clipboard!';
        });
      }
      
      // Auto-load on open
      window.onload = loadData;
    </script>
  </body>
</html>
